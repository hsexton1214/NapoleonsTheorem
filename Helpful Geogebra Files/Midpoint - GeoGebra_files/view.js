window.GGBT_wsf_view=function($,general){"use strict";var APPLET_DETACHED_HTML='<li><a class="wsf-detach-applet toolbar-button"></a></li>',detachedAppletWindow=null,fullscreenContainer=null,fullscreenOriginalParent=null,noSaveOnUnload=false,defaults;if(!general){console.log("general not loaded")}var ismobile=null,mobileAndTabletcheck=function(){var check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true})(navigator.userAgent||navigator.vendor||window.opera);return check};function getFullscreenContainer(){if(fullscreenContainer===null){fullscreenContainer=$('<div id="fullscreencontainer"><div id="fullscreencontent"></div></div>').on("click",function(e){if(e.currentTarget===e.target){history.back();if(fullscreenContainer.find("article").length){toggleAppletFullscreen(false)}}}).appendTo("body");$(document).on("keydown",function(e){if((e.keyCode===27||e.keyCode===8)&&getFullscreenContainer().hasClass("fullscreen")){e.preventDefault();e.stopPropagation();history.back();if(getFullscreenContainer().find("article").length){toggleAppletFullscreen(false)}}});window.onpopstate=function(e){if(getFullscreenContainer().hasClass("fullscreen")){e.preventDefault();e.stopPropagation();if(getFullscreenContainer().find("article").length){toggleAppletFullscreen(false)}}}}return fullscreenContainer}function initWsfTeacherInfoButton(worksheet){var button=$(".wsf-teacher-info-button");button.off("click").on("click",function(e){e.preventDefault();general.initTeacherInfoPage($(this))})}function initWsfElementInfoButton(worksheet){var buttons=$(".wsf-element-info-button");buttons.off("click").on("click",function(e){e.preventDefault();var parent=$(this).parents(".worksheet_element");general.setWsfActiveContent(parent);general.initElementInfoPage($(this))})}function toggleAppletFullscreen(button){var article,width,height,wwidth=$(window).width(),wheight=$(window).height(),scale;if(button){fullscreenOriginalParent=button.parents(".worksheet_element");article=fullscreenOriginalParent.find("article");width=parseInt(article.attr("data-param-width"),10)+20;height=parseInt(article.attr("data-param-height"),10)+20;scale=Math.min(wwidth/width,wheight/height);article.attr("data-scalex",scale).attr("data-scaley",scale);article.appendTo(getFullscreenContainer().find("#fullscreencontent").css("transform","scale("+scale+")"));getFullscreenContainer().addClass("fullscreen");history.pushState({page:1},"pdf")}else{article=getFullscreenContainer().find("article");getFullscreenContainer().removeClass("fullscreen");getFullscreenContainer().find("article").removeAttr("data-scalex").removeAttr("data-scaley").appendTo(fullscreenOriginalParent.find(".applet_container").empty());fullscreenOriginalParent=null}if(window[article.attr("data-param-id")]){window[article.attr("data-param-id")].recalculateEnvironments()}}function initWsfFullscreenButton(worksheet){var buttons=worksheet.find(".wsf-element-fullscreen-button");buttons.off("click").on("click",function(e){e.preventDefault();toggleAppletFullscreen($(this))})}function initWsfPdfFullscreenButton(worksheet){var buttons=worksheet.find(".ws-element-pdf:not([data-download]) .wsf-pdf-popup");buttons.off("click").on("click",function(e){e.preventDefault();var title=$(this).parents(".wsf-content-added").find(".ws-element-title h5").text();window.GGBT_gen_modal.showPdfPopup($(this).attr("href"),title)})}function initWsfButtonInformation(worksheet){var button=general.getButtonInfoClose();button.off("click").on("click",function(e){general.closeInfoFromView();e.preventDefault()})}function initSaveExerciseButtons(mode,worksheet){if(!window.GGBT_gen_edit){return}window.GGBT_gen_edit.initSaveAndContinue(function(e,button){if($(e.target).hasClass("inactive")){return false}if(window.GGBT_gen_edit.getSaveState()!==window.GGBT_gen_edit.SAVE_STATE_INPROGRESS){var setDone=null;e.preventDefault();if(general.getPage().find(".button.jRestart").length){setDone=false}saveUserExamData(setDone,false,function(success){if(success){var doneURL=window.GGBT_gen_edit.getDoneURL();if(e.target.href){if(doneURL&&e.target.href.indexOf("doneurl")<0&&e.target.href.indexOf(doneURL)<0){window.location=e.target.href+"/doneurl/"+encodeURIComponent(doneURL).replace(/%2F/g,"%252F");return}noSaveOnUnload=true;window.location=e.target.href}}});window.GGBT_wsf_comments.saveAllUnsavedComments(general.getWorkSheet())}},worksheet.find(".jSave"));if(worksheet.find(".ws-element-question").length>0){window.GGBT_gen_edit.initSave(function(e,sender){var login=false,tools=general.getPage().find(".jWs-tools");if(tools.length!==0){login=tools.data("user_id")!==undefined&&tools.data("user_id")>0&&!tools.data("inbook")=="1"?true:false}if(login){saveUserExamData(true,false,function done(success){if(success){noSaveOnUnload=true;location.reload()}})}else{markAnswers(sender);general.getPage().find(".jDone").hide();general.getPage().find(".jRestart").show()}},worksheet.find(".jDone"))}else{worksheet.find(".jDone").hide()}worksheet.find(".ws-element-exercise").click(function(){setExerciseModified();$(this).data("isModified","true")});window.GGBT_gen_edit.initSaveAndClose(function(e){var setDone=null;var page=general.getPage();e.preventDefault();if(page.find(".button.jRestart").length){setDone=false}var successFct=function(success){if(success){noSaveOnUnload=true;var doneURL=window.GGBT_gen_edit.getDoneURL();if(e.target.href){if(doneURL&&e.target.href.indexOf("doneurl")<0&&e.target.href.indexOf(doneURL)<0){window.location=e.target.href+"/doneurl/"+encodeURIComponent(doneURL).replace(/%2F/g,"%252F");return}window.location=e.target.href}else if(doneURL){window.location=doneURL}else{window.close()}}};if(saveUserExamData(setDone,false,successFct)===false){successFct(true)}window.GGBT_wsf_comments.saveAllUnsavedComments(general.getWorkSheet())},worksheet.find(".jSaveAndClose"));window.GGBT_gen_edit.initSaveAndContinue(function(e,sender){var page=general.getContainerPage(sender);if(!(page.find(".jWs-tools").data("inbook")=="1")){var save=window.confirm(page.find(".jRestart").data("confirm"));if(save){saveUserExamData(false,true,function done(success){if(success){noSaveOnUnload=true;location.reload()}})}}else{unMarkAnswers(sender);page.find(".jDone").show();page.find(".jRestart").hide()}},worksheet.find(".jRestart"));saveAndClose(mode,worksheet);worksheet.find(".ws-element-restart-button").click(function(){if(!window.confirm($(this).data("confirm"))){return}var element=$(this).parents(".worksheet_element");var exercise=$(".ws-element-exercise",element);var material_id=$(exercise).data("material_id");if(window["applet_"+material_id]===undefined){alert("The applet could not be restarted");return}var applet=window["applet_"+material_id].getAppletObject();applet.setBase64(exercise.data("oribase64"));setExerciseModified();exercise.data("isModified","true")});if(worksheet.find(".jSave").length>0){$(window).bind("beforeunload",function(e){if(!noSaveOnUnload&&isExerciseModified()){var setDone=null;if($(".button.jRestart").length){setDone=false}if(window.GGBT_gen_edit.getSaveState()!==window.GGBT_gen_edit.SAVE_STATE_INPROGRESS){saveUserExamData(setDone,false,null,false);window.GGBT_wsf_comments.saveAllUnsavedComments(general.getWorkSheet())}}})}}function unMarkAnswers(button){var questionChoices=null;var questionAnswers=null;if(button){var container=button.parents(".wsf-ws-scroller");questionChoices=container.find(".ws-question-choices");questionAnswers=container.find(".ws-element-question-answertext")}else{questionChoices=$(".ws-question-choices");questionAnswers=$(".ws-element-question-answertext")}questionChoices.each(function(){removeAnswerOfQuestion($(this))});questionAnswers.each(function(){$(this).find(".ws-open-question-solution").hide()})}function removeAnswerOfQuestion(question){question.find(".ws-question-choice").each(function(){if($(this).data("ticked")===true){$(this).removeClass("ticked")}$(this).find(".answer").removeClass("correct");$(this).find(".answer").removeClass("incorrect");$(this).find(".answer").addClass("placeholder");$(this).find(":input").removeAttr("checked")})}function markAnswers(button){var questionChoices=null;var questionAnswers=null;if(button){var container=button.parents(".wsf-ws-scroller");questionChoices=container.find(".ws-question-choices");questionAnswers=container.find(".ws-element-question-answertext")}else{questionChoices=$(".ws-question-choices");questionAnswers=$(".ws-element-question-answertext")}questionChoices.each(function(){markAnswerOfQuestion($(this))});questionAnswers.each(function(){$(this).find(".ws-open-question-solution").show()})}function markAnswerOfQuestion(question){question.find(".ws-question-choice").each(function(){if($(this).data("ticked")===true){$(this).addClass("ticked")}if(question.data("multiple")===0){if($(this).find(":input").is(":checked")&&$(this).data("ticked")===true){$(this).find(".answer").addClass("correct");$(this).find(".answer").removeClass("placeholder")}else if($(this).find(":input").is(":checked")&&$(this).data("ticked")!==true){$(this).find(".answer").addClass("incorrect");$(this).find(".answer").removeClass("placeholder")}}else{if($(this).find(":input").is(":checked")&&$(this).data("ticked")===true||!$(this).find(":input").is(":checked")&&$(this).data("ticked")!==true){$(this).find(".answer").addClass("correct");$(this).find(".answer").removeClass("placeholder")}else{$(this).find(".answer").addClass("incorrect");$(this).find(".answer").removeClass("placeholder")}}})}function initSaveEvalButtons(mode,worksheet){worksheet.find(".wsf-exercise-toolbar").hide();if(!window.GGBT_gen_edit){return}worksheet.find("#student_worksheets").on("change",function(e){if(worksheet.find(".eval.select").length==worksheet.find(".edit").length){saveEvalData(false)}e.preventDefault();$(this).attr("name",$(this).val());window.location=$("#student_worksheets").attr("name")});worksheet.find(".wsf-evaluation-toolbar.edit .eval").on("click",function(e){var page=general.getContainerPage($(this));page.find(".wsf-evaluation-toolbar.edit .eval").removeClass("select");$(this).addClass("select");saveEvalData(false,function done(success){if(page.find(".eval.select").length>0){page.find(".button.jReopen").show()}else{page.find(".button.jReopen").hide()}})});worksheet.find(".jReturn").on("click",function(e){var page=general.getContainerPage($(this));page.find(".wsf-evaluation-toolbar.edit .eval").removeClass("select");page.find(".wsf-evaluation-toolbar.edit .symbol_50").addClass("select");saveEvalData(false,function done(success){if(success){page.find(".jIncomplete, .jReturn").hide();page.find(".jReopen").show();nextOrClose()}});window.GGBT_wsf_comments.saveAllUnsavedComments(general.getWorkSheet())});worksheet.find(".jIncomplete").on("click",function(e){var page=general.getContainerPage($(this));saveEvalData(true,function done(success){if(success){page.find(".jIncomplete, .jReturn").hide();nextOrClose()}},true);window.GGBT_wsf_comments.saveAllUnsavedComments(general.getWorkSheet())});function nextOrClose(){if($(".s-student").find(".j-nav-next").hasClass("inactive")){window.location.href=window.GGBT_gen_edit.getDoneURL()}else{window.GGBT_gen_edit.setSaveStateError($(".s-student").find(".j-nav-next").data("next-student-msg"));window.location.href=$(".s-student").find(".j-nav-next").attr("href")}}window.GGBT_gen_edit.initSave(function(e,button){var redo=window.confirm(button.data("confirm"));if(redo){saveEvalData(true,function done(success){if(success){window.location.reload()}})}},worksheet.find(".jReopen"));saveAndClose(mode,worksheet)}function saveAndClose(mode,worksheet){window.GGBT_gen_edit.initSave(function(e){window.GGBT_wsf_comments.saveAllUnsavedComments(general.getWorkSheet());if(mode==="eval"){var toEvaluateLength=$(".edit",general.getPage()).length;if(toEvaluateLength>0&&$(".eval.select",general.getPage()).length==toEvaluateLength){saveEvalData(false,function done(success){if(success){windowClose()}})}else{windowClose()}}else if(mode==="exercise"){windowClose()}else{windowClose()}function windowClose(){if(window.opener){window.opener.location.reload();window.close()}else if(e.target.href){window.location=e.target.href}else if($(".jCancel",general.getPage()).href!==""){window.location=$(".jCancel",general.getPage()).get(0).href}}},worksheet.find(".jCancel"))}function getUserExamData(setDone,reset,worksheet){var data={elements:[]};var isDone=true;$(".ws-element-question",worksheet).each(function(idx,question){var questionData=getQuestionData(question);data.elements.push(questionData);if(questionData.data.answers.length===0){isDone=false}});$(".ws-element-exercise",worksheet).each(function(idx,exercise){if(reset||$(this).data("isModified")=="true"){var exerciseData=getExerciseData(exercise);var oriBase64=$(exercise).data("oribase64");data.elements.push(exerciseData);if(exerciseData.data.ggb64===undefined||exerciseData.data.ggb64===oriBase64){isDone=false}}});if(setDone===false){data.markAsDone=false}else if(setDone===true){data.markAsDone=true}else{data.markAsDone=isDone||setDone}if(reset===true){data.reset=true}return data}function getQuestionData(question){var data={id:$(question).data("id"),data:{hasData:true}};var choices=$(".ws-question-choice",question);if(choices.length){data.data.answers=[];$("input:checked",choices).each(function(idx,choice){data.data.answers.push($(choice).data("id"))});data.data.type="tf"}else{data.data.answers=$(".ws-element-question-answertext textarea",question).val();data.data.type="txt"}if(data.data.answers.length===0){data.data.hasData=false}return data}function getExerciseData(exercise){var data={id:$(exercise).data("id"),data:{hasData:true}};var material_id=$(exercise).data("material_id");if(window["applet_"+material_id]===undefined){return data}var applet=window["applet_"+material_id].getAppletObject();if(typeof applet==="object"){var ggb64=applet.getBase64();if($("article",exercise).data("param-ggbbase64")!==ggb64){data.data.ggb64=ggb64}}return data}function saveUserExamData(setDone,reset,done,async){window.GGBT_gen_edit.setSaveStateInProgress();var worksheet=general.getPage();if(async===null||async===undefined){async=true}var data=getUserExamData(setDone,reset,worksheet);data.markAsGraded=false;if(data.elements.length===0){window.GGBT_gen_edit.setSaveStateSuccessful();return false}var fail=function(msg){window.GGBT_gen_edit.setSaveStateError(msg);if(typeof done==="function"){done(false)}};var url=false;if($(".jWs-tools",worksheet).length!==0){url=$(".jWs-tools",worksheet).data("saveurl")}else{url=$(".save-wrapper").data("saveurl")}$.ajax({type:"POST",url:url,data:{data:data},async:async}).done(function(result){if(result.type==="success"){window.GGBT_gen_edit.setSaveStateSuccessful();if(typeof done==="function"){done(true)}}else{fail(result.message)}}).fail(function(result){fail(result.responseText)});return true}function saveEvalData(reopen,done,markAsIncomplete){window.GGBT_gen_edit.setSaveStateInProgress();var page=general.getPage();var user_id=false;if($(".jStudent",page).length!==0){user_id=$(".jStudent",page).data("exercise-student")}else{user_id=$(".wsf-worksheet-title",page).data("exercise-student")}var data={user_id:user_id,markAsGraded:false,markAsDone:true,elements:[]};$(".wsf-evaluation-toolbar",page).each(function(){var mat_eval={id:$(this).parents(".worksheet_element").data("mat-id"),data:{hasData:true}},mat_click=$(this).find(".select");if($(mat_click).length>0&&typeof $(mat_click).data("points")!=="undefined"){mat_eval.points=$(mat_click).data("points")}else{mat_eval.points=null}data.elements.push(mat_eval)});var element_count=$(".ws-element-question, .ws-element-exercise",page).length,select_count=$(".wsf-evaluation-toolbar .eval.select",page).length;if(element_count===select_count){data.markAsGraded=true}else if(select_count===0){data.markAsDone=false}if(reopen){data.markAsDone=false;data.markAsGraded=false}var fail=function(msg){window.GGBT_gen_edit.setSaveStateError(msg);if(done!==undefined){done(false)}};var url=false;if($(".jWs-tools",page).length!==0){url=$(".jWs-tools",page).data("saveurl")}else{url=$(".save-wrapper",page).data("saveurl")}$.post(url,{data:data}).done(function(result){if(result.type==="success"){window.GGBT_gen_edit.setSaveStateSuccessful();if(done!==undefined){if(result.newData){$(".student-state .j-feedback-state-name",page).text($(".student-state",page).data(result.newData));if(result.newData==="complete"){$(".student-state .icon",page).removeClass("icon-status-incomplete").removeClass("icon-status-not_started");$(".student-state .icon",page).addClass("icon-status-complete")}}done(true)}}else{fail(result.message)}}).fail(function(result){fail(result.responseText)})}function initButtons(worksheet){if(worksheet===undefined){worksheet=$("body")}initWsfTeacherInfoButton(worksheet);initWsfElementInfoButton(worksheet);initWsfButtonInformation(worksheet);initWsfFullscreenButton(worksheet);initWsfPdfFullscreenButton(worksheet);var mode=$(general.getWorkSheet().get(0)).data("mode");if(mode==="eval"){initSaveEvalButtons(mode,worksheet)}else{initSaveExerciseButtons(mode,worksheet)}initToolBar()}function initQuestionElements(){jQuery.fn.elasticArea=function(){return this.each(function(){function resizeTextarea(textarea){textarea.style.height=textarea.scrollHeight/2+"px";var height=Math.max(textarea.scrollHeight,60);textarea.style.height=height+"px"}$(this).keypress(function(e){resizeTextarea(e.target)}).keydown(function(e){resizeTextarea(e.target)}).keyup(function(e){resizeTextarea(e.target)}).css("overflow","hidden");resizeTextarea(this)})};$(".ws-element-question-answertext textarea").elasticArea();$(".ws-element-question input, .ws-element-question textarea").change(function(){setExerciseModified()});$(".ws-element-question textarea").keydown(function(){setExerciseModified()});$('[data-bbcodeinput="true"]').each(function(){window.GGBT_texthandlers.initBBCodeEditor($(this),{defaults:defaults,customKeyDown:function(t){setExerciseModified();t.sync()},modalClosed:function(t){setExerciseModified();t.sync()}});$(this).sync()})}var exerciseIsModified=false;function setExerciseModified(modified){exerciseIsModified=modified===undefined}function isExerciseModified(){return exerciseIsModified}function initVideos(worksheet){if(worksheet===undefined||worksheet===null){$(".wsf-ws-scroller").each(function(){initVideos($(this))})}else{worksheet.find(".youtube-player").each(function(){$(this).get(0).addEventListener("onPlayerReady",function(e){console.log("video ready");console.log(e.target)})})}}function initWebElements(worksheet){var elements;if(worksheet===undefined||worksheet===null){elements=$(".jModal")}else{elements=worksheet.find(".jModal")}elements.each(function(){GGBT_wsf_general.initWebElement($(this))});elements.click(function(){var modal=$(this),width=modal.data("width"),height=modal.data("height"),src=modal.data("src"),title=modal.data("title");if(title.length===0){title=src}var bookMenu=$("#menu-container"),onClose=null;if(bookMenu.length===1){var zIndex=bookMenu.css("z-index");bookMenu.css("z-index",1e3);bookMenu.find("#menu").css("z-index",1e3);onClose=function(){bookMenu.css("z-index",zIndex);bookMenu.find("#menu").css("z-index",zIndex)}}window.GGBT_gen_modal.showIframePopup(src,{overlayClose:true,autoResize:true,minWidth:width,minHeight:height},title,null,null,onClose)})}function initToolBar(){$('.worksheet_element[data-type="G"], .worksheet_element[data-type="E"]',general.getWorkSheet()).each(function(idx,elem){var header=$(".ws-element-header.notitle",elem);var width;if($("article",elem).length){width=$("article",elem).data("param-width")}else if($(".applet_container",elem).length){width=$(".applet_container",elem).width()}if(header.length&&width!==undefined){if($("ul li",header).length>1){header.addClass("widetoolbar");$(".wsf-element-toolbar",header).css({right:(width-header.width())*-1})}else{$(".wsf-element-toolbar",header).css({right:(width-header.width()+25)*-1})}}});$(".message_announcement_close").click(function(){var id=$(this).parent().attr("id");id=id.substr(id.lastIndexOf("_")+1);$(this).parents(".message-box").hide();document.cookie="GeoGebraTubeA_"+id+"=1"})}function setAppletFixed(button){var applet=button.parents(".worksheet_element"),article,width,height;article=applet.find("article");article.attr("data-param-id","detachedApplet");width=parseInt(article.attr("data-param-width"),10);height=parseInt(article.attr("data-param-height"),10);if(detachedAppletWindow!==null){detachedAppletWindow.close();localStorage.removeItem("detached");localStorage.removeItem("detachedApplet")}renderGGBElement(article.get(0),function(){window.detachedApplet.registerUpdateListener("detachedAppletUpdated")});detachedAppletWindow=window.open("http://"+window.location.host+"/material/detachapplet/","GeoGebra Applet","width="+(width+16)+", height="+(height+16));localStorage.setItem("detachedApplet",article.clone().addClass("geogebraweb").attr("data-param-usebrowserforjs","true").empty().get(0).outerHTML)}function initAppletControlEvents(html){var fragment=$(html);fragment.find(".wsf-detach-applet").on("click",function(e){setAppletFixed($(this))});return fragment}function initAppletControls(c){if(c.find("article[data-param-fixapplet=true]").length&&!c.find(".wsf-detach-applet").length){c.find(".wsf-element-toolbar").prepend(initAppletControlEvents(APPLET_DETACHED_HTML))}}function initNewWorksheet(worksheet){var oldWorksheet=general.getWorkSheet();general.setWorksheet(worksheet);$(".worksheet_tbl .bbcode-text",worksheet).each(function(){var bbcode=this.textContent||this.innerText;var html=window.GGBT_texthandlers.getHTMLFromBBCode(bbcode);$(this).removeClass(".bbcode-text");$(this).html(html);if(window.GGBT_texthandlers.isLatexRenderer("mathquill")){$(".mathquill-embedded-latex",this).mathquill()}else{window.GGBT_jlatexmath.drawLatexOnjQuery($(".jlatexmath",this))}});if(oldWorksheet&&oldWorksheet.length>0){general.setWorksheet(oldWorksheet)}resizeVideos(false);initVideos(worksheet);initWebElements(worksheet);initPdfElements(worksheet);initButtons(worksheet);initQuestionElements()}function initPdfElements(worksheet){if(worksheet===undefined||worksheet===null){$(".wsf-ws-scroller").each(function(){initPdfElements($(this))})}else{worksheet.find(".ws-element-pdf").each(function(){checkPdfSupport($(this))})}}function initSyncMessageHandler(){window.addEventListener("storage",function(e){var article;var base64=localStorage.getItem("detached");if(base64){window.detachedApplet.setBase64(base64)}else if(detachedAppletWindow!==null&&detachedAppletWindow.closed){article=$("article[data-param-id=detachedApplet]").removeAttr("data-param-id");renderGGBElement(article.get(0));window.detachedApplet=null;localStorage.removeItem("detachedApplet");localStorage.removeItem("detached")}},false);window.detachedAppletUpdated=function(){if(window.detachedApplet){window.detachedApplet.getBase64(function(base64){localStorage.setItem("detached",base64)})}};window.addEventListener("beforeunload",function(e){localStorage.removeItem("detachedApplet");localStorage.removeItem("detached")})}var resizeVideos=function(allWS){var videos=allWS?$(".ws-element-video iframe"):$(".ws-element-video iframe",general.getWorkSheet());videos.each(function(i,e){var windowWidth=typeof window.innerWidth==="number"?window.innerWidth:document.documentElement.clientWidth;var wsRect=$(e).parents(".wsf-ws-scroller")[0].getBoundingClientRect();var rect=e.getBoundingClientRect();var videoBorder=(rect.left-wsRect.left)*2;$(e).css({maxWidth:windowWidth-videoBorder});$(e).parent().css({maxWidth:windowWidth-videoBorder})})};function initResize(){resizeVideos(true);$(window).resize(function(){resizeVideos(true)})}function init(){initResize();general.getWorkSheet();general.getWsfInfoContent();general.getWsfInfo();initQuestionElements();initWebElements();initPdfElements();initButtons();setGraded();logInPopUp();initSyncMessageHandler();initRightPaddingHeadlines()}function initRightPaddingHeadlines(){$.each($(".wsf-content-added"),function(){var elementToolbar=$(this).find(".wsf-element-toolbar");if($("html").attr("dir")=="rtl"){$(this).find(".ws-element-title").css("padding-left",elementToolbar.outerWidth())}else{$(this).find(".ws-element-title").css("padding-right",elementToolbar.outerWidth())}})}function setGraded(){if($(".student-state",general.getPage()).text()===$(".student-state",general.getPage()).data("done")){if($(".wsf-evaluation-toolbar.edit",general.getPage()).length===$(".eval.select",general.getPage()).length){saveEvalData(false,function done(success){if(success){location.reload()}})}}}function logInPopUp(){var login,loginURL,page=general.getPage();if($(".jWs-tools",page).length!==0){login=$(".jWs-tools",page).data("loginmsg");loginURL=$(".jWs-tools",page).data("loginurl")}else{login=$(".wsf-worksheet-title",page).data("login");loginURL=$(".wsf-worksheet-title",page).data("loginurl")}if(login){var redirect=window.confirm(login);if(redirect){window.location=loginURL}else{$(".button.save",page).hide()}}}function setData(d){general.setData(d)}function postProcessApplet(container){if(container){initAppletControls(container.parents(".wsf-content-added"));general.adjustContentToResize(container.parents(".ws-element-applet, .ws-element-exercise"))}if(typeof GGBT_parseLatexes==="function"){setTimeout(GGBT_parseLatexes,200)}}function checkPdfSupport(element){if(ismobile===null){ismobile=mobileAndTabletcheck()}if(ismobile){element.attr("data-popup",true);element.attr("data-download",true)}element.removeAttr("data-checked")}function setDefaults(d){defaults=d}return{init:init,setData:setData,setDefaults:setDefaults,initNewWorksheet:initNewWorksheet,postProcessApplet:postProcessApplet,checkPdfSupport:checkPdfSupport}}(jQuery,GGBT_wsf_general);jQuery(document).ready(function(){"use strict";GGBT_wsf_view.init()});window.GGBT_wsf_comments=function(){"use strict";var data=null;function setData(newData){data=newData;window.GGBT_comments.setData({loggedinuser_id:data.loggedinuser_id,user_right:data.user_right})}function appendToElement(obj){var element=null;if(obj.element_id>0){element=$("#worksheet_element_"+obj.element_id)}else{element=$("#worksheet_element_global")}var comments=element.find(".comments");if(comments.length<=0){return}element.find(".comments.post-comments .count").attr("display");var allowComment=data.loggedinuser_id!==-1&&!(data.type==="C"&&data.user_right==="V");if(!allowComment){comments.find(".new-comment").hide()}obj.commentsArray.forEach(function(item){window.GGBT_comments.appendToCommentList($(".comments-list",element),item);if(item.date_lastread&&item.date_created>item.date_lastread&&item.userid!==data.loggedinuser_id){$(".post-comments",element).show()}});window.GGBT_comments.modifyCommentCounter({comments:comments,comments_counter:obj.comments,toggle:true});window.GGBT_comments.attachHandlersToNewComment(comments)}function saveAllUnsavedComments(worksheet){$(".comments-list .comment.editstate",worksheet).each(function(){var textarea=$(".edit-comment-text",$(this));if(textarea.val()!=$(".comment-text",$(this)).attr("data-content")){window.GGBT_comments.saveEditedComment(textarea)}});$(".comments-list .comment.new-comment",worksheet).each(function(){var textarea=$(".new-comment-text",$(this));if(textarea.val().length>0){window.GGBT_comments.saveNewComment(textarea)}})}function populateComments(){data.elements.forEach(function(item){appendToElement(item)})}function populateCommentContent(){$(".post-comments").hide();$(".post-comments",$("#worksheet_element_global")).show();if(data&&data.elements&&data.elements.length){if(data.elements.length<=2){$(".j-worksheet-comment-button").hide()}populateComments()}}function init(){$(".j-worksheet-comment-button").on("click",function(){var container=$(this).parents(".worksheet_element");if(!$(".post-comments",container).is(":visible")){container.addClass("addComment");setTimeout(function(){container.removeClass("addComment")},1500)}$(".post-comments",container).slideToggle();$(".new-comment-text",container).focus()});populateCommentContent()}return{init:init,setData:setData,saveAllUnsavedComments:saveAllUnsavedComments}}();$(document).ready(function(){"use strict";window.GGBT_wsf_comments.init()});